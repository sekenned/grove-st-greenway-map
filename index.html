<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Grove Street Greenway Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      /* Grove + friends */
      --grove-green: #2ca25f;
      --grove-green-proposed: #1b7a3a; /* darker green for Elm/Orange option */
      --grove-green-halo: #c7e9c0;

      --accent-blue: #2563eb;
      --accent-orange: #f97316;    /* transit */
      --accent-red: #e31a1c;
      --accent-purple: #6a3d9a;    /* all POIs (incl. grocery + library) */
      --accent-teal: #1f9fb5;
      --accent-yellow: #f6c915;    /* Lenape yellow */
      --schools-blue: #1d4ed8;     /* Montclair royal blue */

      --text-muted: #555555;
      --border-soft: #e2e8f0;
      --bg: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: #111827;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 1.25rem 1.5rem 0.75rem;
      border-bottom: 1px solid var(--border-soft);
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    header p {
      margin: 0.35rem 0 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    #map-container {
      flex: 1;
      padding: 0.75rem 1.5rem 1.25rem;
    }

    #map {
      width: 100%;
      height: calc(100vh - 100px);
      max-width: 1200px;
      margin: 0 auto;
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      overflow: hidden;
      position: relative;
    }

    .leaflet-popup-content {
      margin: 0.2rem 0;
      font-size: 0.85rem;
      line-height: 1.3;
    }

    .leaflet-popup-content h3 {
      margin: 0 0 0.15rem;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .leaflet-popup-content p {
      margin: 0.1rem 0;
    }

    /* Combined Layers + Legend control */
    .layers-legend-control {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.12);
      padding: 0.5rem 0.75rem 0.35rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      backdrop-filter: blur(4px);
      min-width: 210px;
    }

    .layers-legend-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.25rem;
      cursor: pointer;
      user-select: none;
    }

    .layers-legend-title {
      font-weight: 600;
      font-size: 0.8rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #0f172a;
    }

    .layers-legend-toggle-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #4b5563;
      background: #ffffff;
    }

    .layers-legend-body {
      margin-top: 0.25rem;
    }

    .layers-legend-control.collapsed .layers-legend-body {
      display: none;
    }

    .layer-section-label {
      margin: 0.3rem 0 0.1rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #6b7280;
    }

    .layer-row {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin: 0.1rem 0;
      line-height: 1.2;
    }

    .layer-row input[type="checkbox"] {
      width: 13px;
      height: 13px;
      margin: 0;
      cursor: pointer;
    }

    .layer-symbol {
      flex: 0 0 auto;
    }

    .layer-label {
      flex: 1 1 auto;
      font-size: 0.78rem;
      color: #111827;
    }

    .layer-symbol-line {
      width: 26px;
      height: 3px;
      border-radius: 999px;
    }

    .layer-symbol-line.grove-main {
      background: var(--grove-green);
    }

    .layer-symbol-line.grove-elm-orange {
      background: var(--grove-green);
      opacity: 0.75;
    }

    .layer-symbol-line.trail-teal {
      background: var(--accent-teal);
    }

    .layer-symbol-line.trail-yellow {
      background: var(--accent-yellow);
    }

    .layer-symbol-line.dashed {
      border-bottom: 2px dashed rgba(15, 23, 42, 0.4);
      background: transparent;
    }

    .layer-symbol-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .dot-transit {
      background: var(--accent-orange);
    }

    .dot-poi {
      background: var(--accent-purple);
    }

    .dot-hospital {
      background: var(--accent-red);
    }

    .dot-park {
      background: var(--grove-green);
    }

    .dot-school {
      background: var(--schools-blue);
    }

    /* Custom vector marker styling (for map markers) */
    .custom-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
      border: 1px solid var(--border-soft);
    }

    .custom-marker svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    .custom-marker-park {
      color: var(--grove-green);
    }

    .custom-marker-school {
      color: var(--schools-blue);
    }

    .custom-marker-transit {
      color: var(--accent-orange);
    }

    .custom-marker-hospital {
      color: var(--accent-red);
    }

    .custom-marker-grocery {
      color: var(--accent-purple);
    }

    .custom-marker-library {
      color: var(--accent-purple);
    }
  </style>
</head>
<body>
  <header>
    <h1>Grove Street Greenway Map</h1>
    <p>Toggle each layer to explore the emerging active-transportation spine through Montclair.</p>
  </header>

  <div id="map-container">
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ---------- Base map ----------
    const lightBase = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>, &copy; CARTO',
        maxZoom: 19,
      }
    );

    const map = L.map("map", {
      center: [40.84, -74.20], // placeholder; will be overridden by Grove bounds
      zoom: 13,
      layers: [lightBase],
      zoomControl: true,
    });

    // Custom panes for z-order of icons
    // (higher zIndex = more front)
    map.createPane("poiPane");
    map.getPane("poiPane").style.zIndex = 410;

    map.createPane("parksPane");
    map.getPane("parksPane").style.zIndex = 420;

    map.createPane("transitPane");
    map.getPane("transitPane").style.zIndex = 430;

    map.createPane("schoolsPane");
    map.getPane("schoolsPane").style.zIndex = 440;

    let overallBounds = L.latLngBounds();
    let groveBounds = L.latLngBounds(); // for Grove Street Greenway focus

    const overlayGroups = {}; // name -> L.LayerGroup

    // ---------- Helper functions ----------

    function extendOverallBounds(layer) {
      try {
        const b = layer.getBounds ? layer.getBounds() : null;
        if (b && b.isValid()) {
          overallBounds.extend(b);
        }
      } catch (e) {
        // Ignore
      }
    }

    function extendGroveBounds(layer) {
      try {
        const b = layer.getBounds ? layer.getBounds() : null;
        if (b && b.isValid()) {
          groveBounds.extend(b);
        }
      } catch (e) {
        // Ignore
      }
    }

    function bindBasicPopup(feature, layer, fallbackTitle) {
      const props = feature.properties || {};
      const title = props.name || fallbackTitle || "Feature";
      const address = props.address;
      const notes = props.notes || props.description || "";

      let html = `<h3>${title}</h3>`;
      if (address) html += `<p>${address}</p>`;
      if (notes) html += `<p>${notes}</p>`;
      layer.bindPopup(html);
    }

    function setLayerVisibility(name, visible) {
      const group = overlayGroups[name];
      if (!group) return;
      if (visible) {
        map.addLayer(group);
      } else {
        map.removeLayer(group);
      }
    }

    // ---------- Vector icons (SVG via divIcon) ----------

    const parkIcon = L.divIcon({
      className: "",
      html: `
        <div class="custom-marker custom-marker-park">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- Trunk -->
            <rect x="10.5" y="12" width="3" height="7" rx="1" ry="1" fill="currentColor" />
            <!-- Canopy: layered circles for a fuller tree -->
            <circle cx="12" cy="10" r="4.5" fill="currentColor" />
            <circle cx="9" cy="10.5" r="3" fill="currentColor" />
            <circle cx="15" cy="10.5" r="3" fill="currentColor" />
          </svg>
        </div>
      `,
      iconSize: [26, 26],
      iconAnchor: [13, 13],
      popupAnchor: [0, -13],
    });

    const schoolIcon = L.divIcon({
      className: "",
      html: `
        <div class="custom-marker custom-marker-school">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- Roof (slightly narrower) -->
            <polygon points="6,11 12,5 18,11" fill="currentColor" />

            <!-- Left wing (narrower) -->
            <rect x="5" y="11" width="3" height="7" fill="currentColor" />
            <!-- Right wing (narrower) -->
            <rect x="16" y="11" width="3" height="7" fill="currentColor" />

            <!-- Center tower (narrower) -->
            <rect x="10" y="10" width="4" height="9" fill="currentColor" />

            <!-- Clock face -->
            <circle cx="12" cy="12.4" r="1.4" fill="#ffffff" />

            <!-- Clock hands -->
            <line x1="12" y1="12.4" x2="12" y2="11.3"
                  stroke="currentColor" stroke-width="0.7" stroke-linecap="round" />
            <line x1="12" y1="12.4" x2="13.1" y2="12.4"
                  stroke="currentColor" stroke-width="0.7" stroke-linecap="round" />

            <!-- Door -->
            <rect x="11.1" y="15" width="1.8" height="4" fill="#ffffff" rx="0.5" />

            <!-- Wing windows -->
            <rect x="5.3"  y="12.5" width="2.4" height="1.4"
                  fill="#ffffff" opacity="0.85" />
            <rect x="16.3" y="12.5" width="2.4" height="1.4"
                  fill="#ffffff" opacity="0.85" />
          </svg>
        </div>
      `,
      iconSize: [26, 26],
      iconAnchor: [13, 13],
      popupAnchor: [0, -13],
    });

    const transitIcon = L.divIcon({
      className: "",
      html: `
        <div class="custom-marker custom-marker-transit">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="5" y="5" width="14" height="11" rx="2" ry="2" fill="currentColor" />
            <rect x="7" y="7" width="4" height="3" fill="#ffffff" />
            <rect x="13" y="7" width="4" height="3" fill="#ffffff" />
            <rect x="9" y="11" width="6" height="2" fill="#ffffff" />
            <line x1="7" y1="18" x2="11" y2="21" stroke="currentColor" stroke-width="1.5" />
            <line x1="17" y1="18" x2="13" y2="21" stroke="currentColor" stroke-width="1.5" />
          </svg>
        </div>
      `,
      iconSize: [26, 26],
      iconAnchor: [13, 13],
      popupAnchor: [0, -13],
    });

    const hospitalIcon = L.divIcon({
      className: "",
      html: `
        <div class="custom-marker custom-marker-hospital">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="10" y="4" width="4" height="16" fill="currentColor" />
            <rect x="4" y="10" width="16" height="4" fill="currentColor" />
          </svg>
        </div>
      `,
      iconSize: [26, 26],
      iconAnchor: [13, 13],
      popupAnchor: [0, -13],
    });

    const groceryIcon = L.divIcon({
      className: "",
      html: `
        <div class="custom-marker custom-marker-grocery">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- Cart basket -->
            <rect x="6" y="9" width="11" height="6" rx="1" ry="1" fill="currentColor" />
            <!-- Handle -->
            <line x1="6" y1="9" x2="4" y2="5" stroke="currentColor" stroke-width="1.5" />
            <!-- Wheels -->
            <circle cx="9" cy="17" r="1.5" fill="currentColor" />
            <circle cx="15" cy="17" r="1.5" fill="currentColor" />
          </svg>
        </div>
      `,
      iconSize: [26, 26],
      iconAnchor: [13, 13],
      popupAnchor: [0, -13],
    });

    const libraryIcon = L.divIcon({
      className: "",
      html: `
        <div class="custom-marker custom-marker-library">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <!-- Closed book -->
            <rect x="6" y="5" width="6" height="14" rx="1" ry="1" fill="currentColor" />
            <!-- Pages hint -->
            <rect x="7" y="6" width="4" height="12" fill="#ffffff" opacity="0.8" />
            <!-- Second book/spine -->
            <rect x="12" y="7" width="5" height="12" rx="1" ry="1"
                  fill="currentColor" opacity="0.85" />
          </svg>
        </div>
      `,
      iconSize: [26, 26],
      iconAnchor: [13, 13],
      popupAnchor: [0, -13],
    });

    // ---------- Point styling ----------

    // Points of Interest (grocery, library, hospital, etc.)
    function poiPointToLayer(feature, latlng) {
      const props = feature.properties || {};
      const cat = (props.category || "").toLowerCase();

      if (cat === "hospital") {
        return L.marker(latlng, { icon: hospitalIcon, pane: "poiPane" });
      }
      if (cat === "grocery") {
        return L.marker(latlng, { icon: groceryIcon, pane: "poiPane" });
      }
      if (cat === "library") {
        return L.marker(latlng, { icon: libraryIcon, pane: "poiPane" });
      }

      // Fallback / mixed-use / other POIs as purple dots
      const styles = getComputedStyle(document.documentElement);
      let fill = styles.getPropertyValue("--accent-purple") || "#6a3d9a";

      return L.circleMarker(latlng, {
        pane: "poiPane",
        radius: 7,
        weight: 1.5,
        color: "#ffffff",
        fillColor: (fill && fill.trim()) || fill,
        fillOpacity: 0.95,
      });
    }

    function poiOnEachFeature(feature, layer) {
      const props = feature.properties || {};
      const cat = (props.category || "").toLowerCase();
      let emoji = "üìç";
      if (cat === "grocery") emoji = "üõí";
      else if (cat === "library") emoji = "üìö";
      else if (cat === "hospital") emoji = "üè•";
      else if (cat === "mixed-use") emoji = "üèôÔ∏è";

      const title = `${emoji} ${props.name || "Point of Interest"}`;
      const address = props.address;
      const notes = props.notes || "";

      let html = `<h3>${title}</h3>`;
      if (address) html += `<p>${address}</p>`;
      if (notes) html += `<p>${notes}</p>`;
      layer.bindPopup(html);
    }

    // Parks
    function parkPointToLayer(feature, latlng) {
      return L.marker(latlng, { icon: parkIcon, pane: "parksPane" });
    }

    function parkOnEachFeature(feature, layer) {
      const props = feature.properties || {};
      const title = `üå≥ ${props.name || "Park"}`;
      const address = props.address;
      const notes = props.notes || props.entrance_description || "";

      let html = `<h3>${title}</h3>`;
      if (address) html += `<p>${address}</p>`;
      if (notes) html += `<p>${notes}</p>`;
      layer.bindPopup(html);
    }

    // Schools
    function schoolPointToLayer(feature, latlng) {
      return L.marker(latlng, { icon: schoolIcon, pane: "schoolsPane" });
    }

    function schoolOnEachFeature(feature, layer) {
      const props = feature.properties || {};
      const title = `üè´ ${props.name || "School"}`;
      const address = props.address;
      const level = props.level;
      const grades = props.grades;
      const notes = props.notes || "";

      let html = `<h3>${title}</h3>`;
      if (address) html += `<p>${address}</p>`;
      if (level || grades) {
        html += `<p>${[level, grades].filter(Boolean).join(" ‚Ä¢ ")}</p>`;
      }
      if (notes) html += `<p>${notes}</p>`;
      layer.bindPopup(html);
    }

    // Transit
    function transitPointToLayer(feature, latlng) {
      return L.marker(latlng, { icon: transitIcon, pane: "transitPane" });
    }

    function transitOnEachFeature(feature, layer) {
      const props = feature.properties || {};
      const mode = (props.mode || "").toLowerCase();
      const line = props.line;
      let emoji = "üöÜ";

      if (mode.includes("bus")) emoji = "üöå";
      if (mode.includes("light_rail")) emoji = "üöà";

      const title = `${emoji} ${props.name || "Transit stop"}`;
      const address = props.address;
      const notes = props.notes || "";

      let html = `<h3>${title}</h3>`;
      if (line) html += `<p>${line}</p>`;
      if (address) html += `<p>${address}</p>`;
      if (notes) html += `<p>${notes}</p>`;
      layer.bindPopup(html);
    }

    // Generic line style builder
    function makeLineStyle(color, weight, dashArray, opacity) {
      return {
        color,
        weight,
        dashArray: dashArray || null,
        opacity: opacity != null ? opacity : 0.9,
      };
    }

    // ---------- Layer configuration ----------

    const layerConfigs = [
      {
        name: "Grove Street Greenway",
        key: "grove-main",
        file: "grove-street-greenway.geojson",
        kind: "grove",
      },
      {
        name: "Elm + Orange Extension (South End Connector)",
        key: "grove-elm-orange",
        file: "MTC_Orang-Elm-Extension.geojson",
        kind: "grove",
      },
      {
        name: "Essex‚ÄìHudson Greenway",
        key: "ehg",
        file: "essex-hudson-greenway.geojson",
        kind: "line",
        colorVariable: "--accent-teal",
        fallbackColor: "#1f9fb5",
        weight: 4,
      },
      {
        name: "Lenape Trail",
        key: "lenape",
        file: "Lenape-trail.geojson",
        kind: "line",
        colorVariable: "--accent-yellow",
        fallbackColor: "#f6c915",
        weight: 3,
        dashArray: "6 4",
        defaultOn: false, // OFF by default
      },
      {
        name: "Morris Canal Greenway (Proposed)",
        key: "morris",
        file: "Morris-Canal.geojson",
        kind: "line",
        colorVariable: "--accent-teal",
        fallbackColor: "#1f9fb5",
        weight: 3,
        dashArray: "4 4",
        defaultOn: false, // OFF by default
      },
      {
        name: "Montclair Transit Hubs",
        key: "transit",
        file: "montclair_transit.geojson",
        kind: "transit",
      },
      {
        name: "Montclair Points of Interest",
        key: "pois",
        file: "mtc-points-of-interest.geojson",
        kind: "poi",
      },
      {
        name: "Montclair Parks",
        key: "parks",
        file: "mtc-parks.geojson",
        kind: "parks",
      },
      {
        name: "Montclair Schools",
        key: "schools",
        file: "mtc_schools.geojson",
        kind: "schools",
      }
    ];

    // Pre-create groups
    layerConfigs.forEach(cfg => {
      overlayGroups[cfg.name] = L.layerGroup();
      if (cfg.defaultOn !== false) {
        overlayGroups[cfg.name].addTo(map);
      }
    });

    // ---------- Combined Layers + Legend Control ----------

    const LayersLegendControl = L.Control.extend({
      options: {
        position: "topright"
      },

      onAdd: function(map) {
        const container = L.DomUtil.create("div", "layers-legend-control leaflet-bar");

        const header = L.DomUtil.create("div", "layers-legend-header", container);
        const title = L.DomUtil.create("div", "layers-legend-title", header);
        title.textContent = "Layers & Legend";

        const icon = L.DomUtil.create("div", "layers-legend-toggle-icon", header);
        icon.innerHTML = "‚ò∞";

        const body = L.DomUtil.create("div", "layers-legend-body", container);

        // Prevent map interactions when using the panel
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);

        // Sections
        const linesLabel = L.DomUtil.create("div", "layer-section-label", body);
        linesLabel.textContent = "Network";

        const lineLayers = [
          { cfgName: "Grove Street Greenway", cssClass: "grove-main", text: "Grove Greenway" },
          { cfgName: "Elm + Orange Extension (South End Connector)", cssClass: "grove-elm-orange", text: "Elm/Orange (concept)" },
          { cfgName: "Essex‚ÄìHudson Greenway", cssClass: "trail-teal", text: "Essex‚ÄìHudson Greenway" },
          { cfgName: "Lenape Trail", cssClass: "trail-yellow dashed", text: "Lenape Trail" },
          { cfgName: "Morris Canal Greenway (Proposed)", cssClass: "trail-teal dashed", text: "Morris Canal (proposed)" }
        ];

        lineLayers.forEach(layerInfo => {
          const row = L.DomUtil.create("label", "layer-row", body);
          const input = L.DomUtil.create("input", "", row);
          input.type = "checkbox";
          input.checked = (layerConfigs.find(c => c.name === layerInfo.cfgName)?.defaultOn !== false);
          input.dataset.layerName = layerInfo.cfgName;

          const symbol = L.DomUtil.create("span", "layer-symbol layer-symbol-line " + layerInfo.cssClass, row);
          const labelSpan = L.DomUtil.create("span", "layer-label", row);
          labelSpan.textContent = layerInfo.text;
        });

        const pointsLabel = L.DomUtil.create("div", "layer-section-label", body);
        pointsLabel.textContent = "Places";

        const pointLayers = [
          { cfgName: "Montclair Transit Hubs", cssClass: "dot-transit", text: "Transit hubs" },
          { cfgName: "Montclair Parks", cssClass: "dot-park", text: "Parks" },
          { cfgName: "Montclair Schools", cssClass: "dot-school", text: "Schools" },
          { cfgName: "Montclair Points of Interest", cssClass: "dot-poi", text: "Points of interest" }
        ];

        pointLayers.forEach(layerInfo => {
          const row = L.DomUtil.create("label", "layer-row", body);
          const input = L.DomUtil.create("input", "", row);
          input.type = "checkbox";
          input.checked = (layerConfigs.find(c => c.name === layerInfo.cfgName)?.defaultOn !== false);
          input.dataset.layerName = layerInfo.cfgName;

          const symbol = L.DomUtil.create("span", "layer-symbol layer-symbol-dot " + layerInfo.cssClass, row);
          const labelSpan = L.DomUtil.create("span", "layer-label", row);
          labelSpan.textContent = layerInfo.text;
        });

        // Wire up the checkboxes
        const inputs = container.querySelectorAll("input[type='checkbox']");
        inputs.forEach(input => {
          input.addEventListener("change", (e) => {
            const name = e.target.dataset.layerName;
            setLayerVisibility(name, e.target.checked);
          });
        });

        // Collapse / expand behavior
        header.addEventListener("click", () => {
          container.classList.toggle("collapsed");
        });

        return container;
      }
    });

    const layersLegendControl = new LayersLegendControl();
    map.addControl(layersLegendControl);

    // ---------- Load layers ----------

    const promises = [];

    layerConfigs.forEach((cfg) => {
      const group = overlayGroups[cfg.name];

      const promise = fetch(cfg.file)
        .then((resp) => resp.json())
        .then((geojson) => {
          let opts = {};

          if (cfg.kind === "grove") {
            // Grove-style halo + core green line
            const rootStyles = getComputedStyle(
              document.documentElement
            );

            const groveGreen =
              rootStyles.getPropertyValue("--grove-green").trim() || "#2ca25f";
            const groveGreenProposed =
              rootStyles
                .getPropertyValue("--grove-green-proposed")
                .trim() || "#1b7a3a";
            const haloColor =
              rootStyles
                .getPropertyValue("--grove-green-halo")
                .trim() || "#c7e9c0";

            const isElmOrange =
              cfg.name.indexOf("Elm + Orange Extension") !== -1 ||
              cfg.name.indexOf("Elm/Orange") !== -1;

            const coreColor = isElmOrange ? groveGreenProposed : groveGreen;
            const coreOpacity = isElmOrange ? 0.75 : 0.95; // ~25% transparent vs Grove
            const haloOpacity = isElmOrange ? 0.45 : 0.55;
            const haloWeight = isElmOrange ? 8 : 10;
            const coreWeight = 6;

            // Halo layer
            const haloLayer = L.geoJSON(geojson, {
              filter: (f) =>
                f.geometry &&
                (f.geometry.type === "LineString" ||
                  f.geometry.type === "MultiLineString"),
              style: {
                color: haloColor,
                weight: haloWeight,
                opacity: haloOpacity,
              },
            });

            // Core green line
            const coreLayer = L.geoJSON(geojson, {
              filter: (f) =>
                f.geometry &&
                (f.geometry.type === "LineString" ||
                  f.geometry.type === "MultiLineString"),
              style: {
                color: coreColor,
                weight: coreWeight,
                opacity: coreOpacity,
              },
              onEachFeature: (feature, layer) => {
                bindBasicPopup(feature, layer, cfg.name);
              },
            });

            haloLayer.addTo(group);
            coreLayer.addTo(group);

            // Center on Grove + Elm/Orange together
            extendGroveBounds(coreLayer);

            extendOverallBounds(coreLayer);

            return;
          }

          if (cfg.kind === "line") {
            const colorVar = cfg.colorVariable
              ? getComputedStyle(document.documentElement).getPropertyValue(
                  cfg.colorVariable
                )
              : "";
            const lineColor =
              (colorVar && colorVar.trim()) ||
              cfg.fallbackColor ||
              "#1f9fb5";

            const opacity = 0.9;

            opts = {
              style: () =>
                makeLineStyle(lineColor, cfg.weight || 3, cfg.dashArray, opacity),
              onEachFeature: (feature, layer) => {
                bindBasicPopup(feature, layer, cfg.name);
              },
            };

            const lineLayer = L.geoJSON(geojson, opts).addTo(group);
            extendOverallBounds(lineLayer);
            return;
          }

          if (cfg.kind === "poi") {
            opts = {
              pointToLayer: poiPointToLayer,
              onEachFeature: poiOnEachFeature,
            };
          } else if (cfg.kind === "parks") {
            opts = {
              pointToLayer: parkPointToLayer,
              onEachFeature: parkOnEachFeature,
            };
          } else if (cfg.kind === "schools") {
            opts = {
              pointToLayer: schoolPointToLayer,
              onEachFeature: schoolOnEachFeature,
            };
          } else if (cfg.kind === "transit") {
            opts = {
              pointToLayer: transitPointToLayer,
              onEachFeature: transitOnEachFeature,
            };
          }

          const layer = L.geoJSON(geojson, opts).addTo(group);
          extendOverallBounds(layer);
        })
        .catch((err) => {
          console.error(`Failed to load ${cfg.file}`, err);
        });

      promises.push(promise);
    });

    Promise.all(promises).then(() => {
      // Prefer fitting to Grove Street Greenway; fall back to all layers if needed
      if (groveBounds.isValid()) {
        map.fitBounds(groveBounds.pad(0.08));
      } else if (overallBounds.isValid()) {
        map.fitBounds(overallBounds.pad(0.08));
      }
    });

    // ---------- Notes ----------
    // - For local testing, run a simple static server in this folder:
    //     python -m http.server 8000
    //   then open: http://localhost:8000
    //
    // - To embed in Google Sites:
    //     1. Host this file + GeoJSON on GitHub Pages / Netlify / etc.
    //     2. Use "Embed" -> "By URL" and paste the map page URL.
  </script>
</body>
</html>
